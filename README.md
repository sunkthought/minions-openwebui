# Minion/MinionS Open WebUI Function Generator

This project refactors the Minion and MinionS pipe functions for Open WebUI into a modular structure using partial Python files. A generator script (intended) and a configuration file are provided to assemble these partials into complete, usable Open WebUI function files.

## Project Structure

-   **`partials/`**: Contains the building blocks (Python code snippets) for the functions.
    -   **`common_*.py`**: Code shared between different function types (e.g., API call logic, context utilities).
    -   **`minion_*.py`**: Code specific to the Minion protocol.
    -   **`minions_*.py`**: Code specific to the MinionS protocol.
-   **`generation_config.json`**: A JSON configuration file that defines profiles for generating different function variations. Each profile specifies which partials to use, header information, and how different components should be wired together.
-   **`generator_script.py`**: (Intended) A Python script to read a profile from `generation_config.json` and assemble the corresponding partials into a complete function file.
-   **`generated_functions/`**: (Intended) The default output directory where generated function files will be saved by `generator_script.py`.
-   **Original Files**:
    -   `minion-fn-claude.py`: The original Minion function.
    -   `minions-fn-claude.py`: The original MinionS function.

## Partials

The code for the Minion and MinionS functions has been broken down into smaller, more manageable partial files. This allows for:

-   Easier maintenance and updates to specific logic.
-   Better code reusability across different function types or versions.
-   Future customization by potentially swapping out partials (e.g., different chunking methods, different protocol steps).

Key partials include:
-   Headers (`common_header.py`)
-   Imports (`common_imports.py`)
-   API calling utilities (`common_api_calls.py`)
-   Context processing (`common_context_utils.py`)
-   Base Pipe class structure (`common_pipe_utils.py`)
-   Specific Pydantic models for Valves and responses (`minion_valves.py`, `minion_models.py`, `minions_valves.py`, `minions_models.py`)
-   Core protocol logic (`minion_protocol_logic.py`, `minions_protocol_logic.py`)
-   Main pipe execution methods (`minion_pipe_method.py`, `minions_pipe_method.py`)
-   Token savings calculations (`minion_token_savings.py`, `minions_token_savings.py`)

## Configuration (`generation_config.json`)

The `generation_config.json` file allows you to define different "profiles" for generating functions. Each profile specifies:

-   `description`: A human-readable description.
-   `output_filename_template`: How the output file should be named.
-   `target_pipe_class_name`, `target_pipe_name_in_init`, `target_pipe_id_in_init`: Naming for the final Pipe class.
-   `header_placeholders`: Values for title, author, version, etc., in the generated file's header.
-   `partials_concat_order`: The sequence in which to concatenate partial files. These paths are relative to the directory specified by `--partials_dir` in the generator script.
-   `specific_imports_map`: A map to help the generator script create necessary `from ... import ...` statements for classes and functions defined in the partials.
-   `execute_protocol_dependencies_map`: Defines how the main protocol execution function (e.g., `execute_minion_protocol`) receives its dependencies (like API call functions or specific data models).

**Example Profile Snippet (from `minion_default`):**

```json
{
  "minion_default": {
    "description": "Default Minion function using Claude.",
    "output_filename_template": "minionpipe_function.py",
    "target_pipe_class_name": "MinionPipe",
    // ... other metadata ...
    "header_placeholders": {
      "TITLE": "Minion Protocol Integration for Open WebUI",
      "AUTHOR": "Generated by Script",
      "VERSION": "0.2.1-generated",
      "DESCRIPTION": "Basic Minion protocol..."
    },
    "partials_concat_order": [
      "common_header.py",
      // ... common imports are handled by generator ...
      "common_api_calls.py",
      // ... more partials ...
      "minion_pipe_method.py"
    ],
    "specific_imports_map": {
      "LocalAssistantResponse": "minion_models",
      "MinionValves": "minion_valves",
      // ... more imports ...
    },
    "execute_protocol_dependencies_map": {
      "call_claude_func": "call_claude_api",
      // ... more dependencies ...
    }
  }
}
```

## Generator Script (`generator_script.py`)

**Intended Functionality:**

The `generator_script.py` is designed to automate the process of building a complete Open WebUI function file from the partials based on a selected profile in `generation_config.json`.

**Intended Usage:**

```bash
python generator_script.py --profile <profile_name> [--config_file path/to/config.json] [--partials_dir path/to/partials/] [--output_dir path/to/output/]
```

-   `--profile`: (Required) The name of the profile to use from the config file (e.g., `minion_default`).
-   `--config_file`: (Optional) Path to the generation config JSON file. Defaults to `generation_config.json`.
-   `--partials_dir`: (Optional) Path to the directory containing partial files. Defaults to `partials/`.
-   `--output_dir`: (Optional) Path to the directory where the generated file should be saved. Defaults to `generated_functions/`.

The script would then:
1.  Load the specified profile from the configuration file.
2.  Read the content of `common_header.py` and format it with placeholders from the profile.
3.  Generate necessary import statements based on `specific_imports_map`.
4.  Concatenate the content of common and profile-specific partials in the order defined by `partials_concat_order`.
5.  Dynamically construct the final `Pipe` class (e.g., `MinionPipe` or `MinionsPipe`) that inherits from `common_pipe_utils.PipeBase`. This class would correctly initialize its specific `Valves` and wire up its methods to call the standalone functions defined in the partials, managing dependencies as specified in `execute_protocol_dependencies_map`.
6.  Save the resulting Python code to a file in the output directory.

**Current Status of `generator_script.py`:**

Unfortunately, persistent environment/tooling issues were encountered during development that prevented the successful writing and execution of the complete `generator_script.py`. The script in its current state in the repository is likely a minimal, non-functional version.
The `generation_config.json` file and all partials have been created as planned. Users may need to debug `generator_script.py` or manually assemble the functions using the partials and the config file as a guide.

## Future Enhancements (Suggestions from User Feedback)

-   **Granular Partials**: Further break down complex partials (like `minions_protocol_logic.py`) into smaller, more focused components (e.g., separate files for different decomposition methods, chunking strategies, or task execution approaches). This would allow these components to be more easily swapped or customized via the `generation_config.json`.
-   **Robust Generator Script**: Resolve the issues with `generator_script.py` to make it fully functional.

## How to Manually Assemble (If Generator Script Fails)

1.  Choose a profile from `generation_config.json` (e.g., `minion_default`).
2.  Create a new Python file (e.g., `my_custom_minion.py`).
3.  Copy the content of `partials/common_header.py` and replace the placeholders (e.g., `{TITLE}`) using the values from the profile's `header_placeholders`.
4.  Add all imports from `partials/common_imports.py`.
5.  For each item in the profile's `specific_imports_map`, generate the corresponding import statement (e.g., `from partials.minion_models import LocalAssistantResponse`).
6.  Concatenate the content of all Python files listed in the profile's `partials_concat_order` (ensure `common_header.py` and `common_imports.py` are handled correctly at the beginning, and `common_pipe_utils.py` which contains `PipeBase` is included before the final Pipe class definition).
7.  Manually construct the final `Pipe` class. This class should:
    -   Inherit from `PipeBase` (defined in `partials/common_pipe_utils.py`).
    -   In its `__init__`, call `super().__init__(name=..., id=...)` with values from the profile, and initialize `self.valves` with the correct `Valves` class (e.g., `self.valves = MinionValves()`).
    -   Implement the `async def pipe(self, body, __user__, ...)` method. This method should call the standalone pipe function from the corresponding partial (e.g., `minion_pipe_method.minion_pipe`), passing `self` and other arguments.
    -   To make this work, ensure that helper functions (like `call_claude_api`, `execute_minion_protocol`, `LocalAssistantResponse`, etc.) are correctly passed to or made accessible by `minion_pipe` (and subsequently `execute_minion_protocol`) as per the `execute_protocol_dependencies_map`. This might involve attaching them to `self` within the `pipe` method before calling the standalone `minion_pipe` function, as was the strategy for the generator script.
8.  The resulting file should then be usable in Open WebUI.
```
